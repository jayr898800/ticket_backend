<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Request Repair Ticket</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url("background.png") center/cover no-repeat;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .card {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(8px);
      padding: 30px;
      border-radius: 16px;
      max-width: 600px; width: 100%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .card h1 {font-size: 24px; font-weight: 800; color:#1d79f2; margin:0 0 8px; text-align:center;}
    .card p {font-size: 14px; color:#3f7fcf; margin:0 0 20px; text-align:center;}
    .form-group, .input-row {margin-bottom:16px;}
    label {display:block; font:600 14px Arial; margin-bottom:4px; color:#444;}
    .input-row {display:flex; gap:10px;}
    input, textarea, select {
      width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:8px;
      font-size:14px; box-sizing:border-box; transition:.2s;
    }
    input:focus,textarea:focus,select:focus {border-color:#1d79f2; box-shadow:0 0 6px rgba(29,121,242,0.3); outline:none;}
    textarea {resize:none; height:80px;}
    .upload-section {margin-bottom:16px;}
    .upload-section button {
      background:#1d79f2; color:#fff; border:0; border-radius:30px;
      padding:8px 16px; font-size:13px; font-weight:600; cursor:pointer;
      transition:transform .15s;
    }
    .upload-section button:hover {transform:scale(1.05);}
    .upload-section small {font-size:12px; color:#666;}
    .preview {display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .preview img {width:90px; height:70px; object-fit:cover; border-radius:6px; border:1px solid #ccc;}
    .btn {
      background:linear-gradient(135deg,#1d79f2,#0f5fd8); color:#fff; border:0;
      width:240px; padding:12px 0; border-radius:30px; font:700 14px Arial;
      cursor:pointer; display:block; margin:18px auto; transition:transform .15s;
    }
    .btn:hover {transform:scale(1.05);}
    .btn.loading {pointer-events:none; opacity:.8;}
    .spinner {
      border:3px solid rgba(255,255,255,0.4); border-top:3px solid #fff;
      border-radius:50%; width:16px; height:16px; display:inline-block;
      animation:spin 1s linear infinite; margin-right:6px; vertical-align:middle;
    }
    @keyframes spin {to{transform:rotate(360deg);}}
    .footer-text {text-align:center; font-size:13px; margin-top:12px;}
    .footer-text a {color:#1d79f2; font-weight:600; text-decoration:none;}
    input[type="file"]{display:none;}

    /* Modal */
    .modal {
      display:none; position:fixed; z-index:1000; inset:0;
      background:rgba(0,0,0,0.6); justify-content:center; align-items:flex-start;
      overflow-y:auto; padding:50px 0;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:16px;
      text-align:center; max-width:500px; width:90%; margin:auto;
      box-shadow:0 6px 20px rgba(0,0,0,0.2);
    }
    .logo-img {width:160px; margin:0 auto -10px;}
    h3 {margin:8px 0;font-size:18px;}
    p {margin:4px 0;font-size:14px;}
    #ticketNumber {
      border:2px dashed #1d79f2; font:700 24px Arial;
      letter-spacing:6px; color:#1d79f2;
      margin:15px 0; padding:10px;
    }
    #ticketDate, #ticketCode, #ticketTypeDisplay {font-size:13px;color:#444;margin:2px 0;}
    .warning {color:red;font-size:13px;margin:8px 0;}
    .btn-ticket {
      background:#1d79f2; border:0; color:#fff;
      border-radius:30px; padding:12px 20px;
      margin:6px auto; cursor:pointer;
      display:block; width:220px;
      font-weight:600; font-size:14px;
      transition:transform .15s;
    }
    .btn-ticket:hover {transform:scale(1.05);}
    .toast {
      visibility:hidden; min-width:200px;
      background:rgba(29,121,242,0.9); color:#fff;
      text-align:center; border-radius:30px; padding:10px 16px;
      position:fixed; left:50%; bottom:30px; transform:translateX(-50%);
      font:600 13px Arial; opacity:0; transition:.3s;
    }
    .toast.show {visibility:visible; opacity:1; bottom:50px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>REQUEST A REPAIR TICKET</h1>
    <p>You can generate a ticket instantly.</p>

    <form id="ticketForm" enctype="multipart/form-data">
      <div class="input-row">
        <input type="text" name="firstName" placeholder="Name">
        <input type="text" name="middleName" placeholder="Middle Name">
      </div>
      <div class="input-row">
        <input type="text" name="lastName" placeholder="Last Name">
        <input type="text" name="suffix" placeholder="Suffix">
      </div>

      <!-- Contact + Ticket Type on same row -->
      <div class="input-row">
        <div class="form-group" style="flex:1;">
          <label>Contact Number</label>
          <input type="text" name="contactNumber" placeholder="09395791316">
        </div>
        <div class="form-group" style="flex:1;">
          <label>Ticket Type</label>
          <select name="ticketType" required>
            <option value="" disabled selected>-- Select --</option>
            <option value="Free Checkup">Free Checkup</option>
            <option value="Repair">Repair</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Unit</label>
        <input type="text" name="unit" placeholder="e.g. Samsung TV, iPhone 14 Pro Max...">
      </div>
      <div class="form-group">
        <label>Problem</label>
        <textarea name="problem" placeholder="Describe the issue..."></textarea>
      </div>

      <div class="upload-section">
        <label>Upload Images</label>
        <button type="button" id="chooseFilesBtn">Choose Files</button>
        <input type="file" id="fileInput" name="images" accept="image/*" multiple>
        <small>Max 5 images, up to 10MB each</small>
        <div class="preview" id="preview"></div>
      </div>

      <button type="submit" class="btn" id="submitBtn">SUBMIT TICKET</button>
      <div class="footer-text">Already have the ticket? <a href="checking_ticket_status.html">Check status here.</a></div>
    </form>
  </div>

  <!-- Modal -->
  <div id="ticketModal" class="modal">
    <div class="modal-content">
      <img src="logo.png" alt="Logo" class="logo-img">
      <h3>RONALD'S ELECTRONIC SHOP</h3>
      <p id="ticketTypeDisplay"></p>
      <p>Ticket Number:</p>
      <div id="ticketNumber"></div>
      <div id="ticketDate"></div>
      <div id="ticketCode"></div>
      <p class="warning">For your convenience, you can track the status of your unit online via our website</p>
      <button class="btn-ticket" onclick="takeScreenshot()">ðŸ“¸ Take Screenshot</button>
      <button class="btn-ticket" onclick="copyTicket()">ðŸ“‹ Copy Ticket</button>
      <button class="btn-ticket" onclick="closeModal()">Done</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const form = document.getElementById("ticketForm"),
          fileInput = document.getElementById("fileInput"),
          chooseBtn = document.getElementById("chooseFilesBtn"),
          preview = document.getElementById("preview"),
          ticketModal = document.getElementById("ticketModal"),
          ticketNumberEl = document.getElementById("ticketNumber"),
          ticketTypeDisplay = document.getElementById("ticketTypeDisplay"),
          toast = document.getElementById("toast"),
          submitBtn = document.getElementById("submitBtn");

    let toastTimeout;

    chooseBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
      preview.innerHTML = "";
      [...fileInput.files].forEach(f => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        preview.appendChild(img);
      });
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      setLoading(true);
      await new Promise(r => setTimeout(r, 1500));
      try {
        const res = await fetch("http://localhost:5000/api/tickets",{method:"POST",body:new FormData(form)});
        const data = await res.json();
        if(res.ok){
          const now=new Date(), ticketNum=data.ticketNumber;
          ticketNumberEl.textContent=ticketNum;
          document.getElementById("ticketDate").textContent=now.toLocaleString();
          document.getElementById("ticketCode").textContent="Ticket Code: "+ticketNum.split("-").pop();
          ticketTypeDisplay.textContent="Service: " + (form.ticketType.value || "N/A");
          ticketModal.style.display="flex";
        } else showToast("Error: "+(data.error||"Something went wrong"));
      } catch { showToast("Failed to connect"); }
      finally { setLoading(false); }
    });

    function setLoading(isLoading){
      if(isLoading){
        submitBtn.classList.add("loading");
        submitBtn.innerHTML='<span class="spinner"></span> Generating...';
      } else {
        submitBtn.classList.remove("loading");
        submitBtn.textContent="SUBMIT TICKET";
      }
    }
    function closeModal(){ticketModal.style.display="none"; form.reset(); preview.innerHTML="";}
    function showToast(msg){
      clearTimeout(toastTimeout);
      toast.textContent=msg; toast.classList.add("show");
      toastTimeout=setTimeout(()=>toast.classList.remove("show"),2000);
    }
    function takeScreenshot(){
      html2canvas(document.querySelector("#ticketModal .modal-content"),{scale:2,backgroundColor:"#fff"})
      .then(canvas=>{
        const link=document.createElement("a");
        const ticketNum=ticketNumberEl.textContent.trim();
        link.download=`ticket-${ticketNum}.png`; link.href=canvas.toDataURL("image/png"); link.click();
        showToast("Screenshot saved");
      });
    }
    function copyTicket(){
      const ticketNum=ticketNumberEl.textContent.trim();
      navigator.clipboard.writeText(ticketNum).then(()=>showToast("Copied!"))
        .catch(()=>showToast("Clipboard blocked"));
    }
  </script>
</body>
</html>
